<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>What To Draw ‚Äî Updated Palette System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050814;
      --bg-elevated: #0c101f;
      --bg-elevated-soft: #101528;
      --bg-chip: #151a2b;
      --accent: #4aa8ff;
      --accent-soft: rgba(74, 168, 255, 0.2);
      --border-subtle: rgba(255,255,255,0.06);
      --text-main: #f7f8ff;
      --text-muted: #a3acc7;
      --text-soft: #6e7692;
      --danger: #ff5c7a;
      --corner-radius-lg: 18px;
      --corner-radius-md: 12px;
      --shadow-soft: 0 22px 60px rgba(0,0,0,0.6);
      --font-sans: -apple-system, BlinkMacSystemFont, system-ui, "SF Pro Text",
        -system-ui, sans-serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-sans);
      color: var(--text-main);
      background: radial-gradient(circle at top, #1a2340 0%, #050814 55%, #02030a 100%);
      background-attachment: fixed;
      background-size: cover;
      min-height: 100vh;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 0% 0%, rgba(79, 185, 255, 0.16), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(255, 88, 178, 0.16), transparent 55%);
      opacity: 0.8;
      mix-blend-mode: screen;
      z-index: -1;
    }

    .app-shell {
      max-width: 1240px;
      margin: 26px auto 40px auto;
      padding: 0 20px 40px 20px;
    }

    h1 {
      margin: 0;
      font-weight: 800;
      letter-spacing: 0.08em;
      font-size: clamp(32px, 4vw, 40px);
    }

    .subtitle {
      margin-top: 6px;
      font-size: 14px;
      color: var(--text-soft);
    }

    .top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 22px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .controls-main {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 10px 22px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      transition: background 0.14s ease, transform 0.08s ease, box-shadow 0.14s ease,
        border-color 0.14s ease, color 0.14s ease;
      background: transparent;
      color: var(--text-main);
    }

    .btn.primary {
      background: linear-gradient(135deg, #45a2ff, #8b7bff);
      color: white;
      box-shadow: 0 12px 30px rgba(34, 142, 255, 0.55);
      border-color: rgba(255,255,255,0.1);
    }

    .btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(34, 142, 255, 0.7);
    }

    .btn.toggle {
      background: rgba(10, 15, 30, 0.7);
      border-color: rgba(255,255,255,0.04);
      color: var(--text-muted);
    }

    .btn.toggle.active {
      background: rgba(32, 45, 90, 0.95);
      border-color: var(--accent-soft);
      color: var(--text-main);
      box-shadow: 0 0 0 1px rgba(113, 190, 255, 0.4);
    }

    .btn.ghost {
      padding-inline: 16px;
      border-color: rgba(255,255,255,0.08);
      background: rgba(6, 9, 22, 0.7);
      color: var(--text-soft);
      font-size: 13px;
    }

    .btn.ghost.active {
      background: rgba(22, 30, 55, 0.95);
      border-color: rgba(255,255,255,0.18);
      color: var(--text-main);
    }

    .emoji { font-size: 16px; }

    .branch-row-wrapper { margin-top: 18px; }

    .branch-label {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .branch-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .branch-pill {
      border-radius: 999px;
      background: rgba(10, 14, 30, 0.86);
      border: 1px solid rgba(255,255,255,0.04);
      padding: 6px 14px 7px 14px;
      font-size: 13px;
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.14s ease, border-color 0.14s ease, color 0.14s ease,
        box-shadow 0.14s ease, transform 0.08s ease;
    }

    .branch-pill span.icon { font-size: 14px; }

    .branch-pill.active {
      background: rgba(33, 52, 101, 0.98);
      border-color: var(--accent-soft);
      color: var(--text-main);
      box-shadow: 0 10px 26px rgba(0,0,0,0.5);
      transform: translateY(-0.5px);
    }

    .branch-row.disabled .branch-pill {
      opacity: 0.35;
      pointer-events: none;
    }

    .card {
      margin-top: 18px;
      border-radius: var(--corner-radius-lg);
      background: rgba(7, 10, 24, 0.96);
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: var(--shadow-soft);
      padding: 18px 22px 18px 22px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      margin-bottom: 10px;
    }

    .card-header-main {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .branch-icon-circle {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: radial-gradient(circle at 25% 20%, #ffffff, #d2d9ff);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 26px rgba(0,0,0,0.65);
      flex-shrink: 0;
    }

    .branch-icon-circle span { font-size: 18px; }

    .card-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .card-title-eyebrow {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .card-title-main {
      font-size: 20px;
      font-weight: 700;
    }

    .card-title-sub {
      font-size: 12px;
      color: var(--text-soft);
    }

    .card-header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card-body {
      margin-top: 6px;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(260px, 1.1fr);
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .card-body {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .detail-block { padding-top: 4px; }

    .detail-grid {
      display: grid;
      grid-template-columns: 140px minmax(0, 1fr);
      column-gap: 16px;
      row-gap: 4px;
      font-size: 13px;
    }

    @media (max-width: 640px) {
      .detail-grid {
        grid-template-columns: 120px minmax(0, 1fr);
      }
    }

    .field-label {
      color: var(--text-soft);
      font-weight: 500;
      padding: 2px 0;
      white-space: nowrap;
    }

    .field-value {
      color: var(--text-main);
      padding: 2px 0;
    }

    .field-muted {
      color: var(--text-soft);
      font-style: italic;
    }

    .palette-card {
      border-radius: var(--corner-radius-md);
      background: var(--bg-elevated-soft);
      border: 1px solid var(--border-subtle);
      padding: 10px 12px 12px 12px;
    }

    .palette-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .palette-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .palette-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
    }

    .palette-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .palette-controls {
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .palette-controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .palette-count-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .palette-count-buttons {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    select {
      background: #050816;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--text-main);
      font-size: 11px;
      padding: 5px 28px 5px 10px;
      outline: none;
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #ffffff 50%),
        linear-gradient(135deg, #ffffff 50%, transparent 50%);
      background-position: calc(100% - 13px) 8px, calc(100% - 9px) 8px;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }

    .swatch-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .swatch {
      width: 30px;
      height: 30px;
      border-radius: 9px;
      border: 1px solid rgba(0,0,0,0.35);
      box-shadow: 0 5px 14px rgba(0,0,0,0.65);
      position: relative;
      cursor: pointer;
    }

    .swatch::after {
      content: attr(data-role);
      position: absolute;
      left: 50%;
      bottom: -18px;
      transform: translateX(-50%);
      font-size: 9px;
      color: var(--text-soft);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.12s ease;
      white-space: nowrap;
    }

    .swatch:hover::after { opacity: 1; }

    .hex-row {
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-soft);
      word-break: break-all;
    }

    .hex-note {
      font-size: 10px;
      color: var(--text-soft);
      opacity: 0.9;
    }

    .favorites-panel {
      margin-top: 16px;
      border-radius: var(--corner-radius-lg);
      background: rgba(5, 7, 17, 0.96);
      border: 1px solid rgba(255,255,255,0.04);
      padding: 10px 16px 12px 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      display: none;
    }

    .favorites-panel.visible { display: block; }

    .favorites-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .favorites-header-title {
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .favorites-empty {
      padding: 6px 0 4px 0;
      font-size: 12px;
      color: var(--text-soft);
    }

    .favorite-item {
      border-top: 1px solid rgba(255,255,255,0.06);
      padding: 8px 0 9px 0;
    }

    .favorite-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .favorite-branch {
      font-weight: 500;
      color: var(--text-main);
    }

    .favorite-body {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .favorite-swatches {
      display: flex;
      gap: 4px;
      margin-bottom: 6px;
    }

    .favorite-swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.35);
    }

    .favorite-actions {
      display: flex;
      gap: 6px;
    }

    .btn-mini {
      border-radius: 999px;
      padding: 3px 9px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(13, 16, 30, 0.95);
      font-size: 10px;
      color: var(--text-soft);
      cursor: pointer;
    }

    .btn-mini.danger {
      border-color: rgba(255,93,114,0.75);
      color: #ff9aa9;
    }

    .btn-mini:disabled {
      opacity: 0.35;
      cursor: default;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <h1>WHAT TO DRAW</h1>
      <div class="subtitle">
        Tap once to get a structured idea: characters, devices, buildings,
        creatures, plants, scenes, and more.
      </div>
    </header>

    <div class="top-row">
      <div class="controls-main">
        <button id="btn-generate" class="btn primary">
          <span>Generate Idea</span> <span class="emoji">üé≤</span>
        </button>

        <button id="btn-random-mode" class="btn toggle active">
          Random Branch
        </button>
        <button id="btn-pick-mode" class="btn toggle">
          Pick Branch
        </button>
      </div>

      <button id="btn-favorites-toggle" class="btn ghost">
        ‚≠ê Favorites (<span id="favorites-count">0</span>)
      </button>
    </div>

    <div class="branch-row-wrapper">
      <div class="branch-label">Branches:</div>
      <div id="branch-row" class="branch-row"></div>
    </div>

    <section class="card" id="result-card">
      <div class="card-header">
        <div class="card-header-main">
          <div class="branch-icon-circle" id="branch-icon">
            <span>üé≤</span>
          </div>
          <div class="card-title-block">
            <div class="card-title-eyebrow" id="branch-eyebrow">Branch</div>
            <div class="card-title-main" id="branch-title">Waiting for idea...</div>
            <div class="card-title-sub" id="branch-subtitle">
              Tap Generate to get started.
            </div>
          </div>
        </div>
        <div class="card-header-actions">
          <button id="btn-copy-idea" class="btn toggle">Copy Idea üìã</button>
          <button id="btn-favorite-current" class="btn toggle">
            Add to Favorites ‚≠ê
          </button>
        </div>
      </div>

      <div class="card-body">
        <div class="detail-block">
          <div class="detail-grid" id="detail-grid"></div>
        </div>

        <aside class="palette-card">
          <div class="palette-header">
            <div class="palette-title-block">
              <div class="palette-title">Color Palette</div>
              <div class="palette-sub" id="palette-label">
                Palette mode
              </div>
            </div>
            <button id="btn-copy-hex" class="btn-mini">Copy HEX</button>
          </div>

          <div class="palette-controls">
            <div class="palette-controls-row">
              <select id="palette-mode">
                <!-- Conceptual / curated vibe modes -->
                <option value="warm">Warm / Energetic</option>
                <option value="cool">Cool / Calm</option>
                <option value="muted">Muted / Dusty</option>
                <option value="noir">Noir / High Contrast</option>
                <option value="earth">Earthy / Natural</option>
                <option value="pastel">Pastel / Soft</option>
                <option value="neon">Neon / Cyber</option>
                <option value="rust">Rust / Industrial</option>
                <option value="cosmic">Cosmic / Iridescent</option>
                <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                <!-- Color theory modes -->
                <option value="mono">Monochromatic</option>
                <option value="analogous">Analogous</option>
                <option value="complementary">Complementary</option>
                <option value="splitComp">Split-Complementary</option>
                <option value="triadic">Triadic</option>
              </select>
              <button id="btn-palette-random" class="btn-mini" title="Random palette mode & colors">
                üé≤
              </button>
            </div>

            <div class="palette-count-row">
              <span>Colors:</span>
              <div class="palette-count-buttons">
                <button id="btn-colors-minus" class="btn-mini" disabled>-</button>
                <span id="color-count-label">5</span>
                <button id="btn-colors-plus" class="btn-mini">+</button>
              </div>
            </div>
          </div>

          <div class="swatch-row" id="swatch-row"></div>
          <div class="hex-row" id="hex-row"></div>
          <div class="hex-row">
            <span class="hex-note">
              Click a color to copy it ‚Ä¢ Left to right: Primary, Secondary, Accent, Neutral, Pop (then extended accents)
            </span>
          </div>
        </aside>
      </div>
    </section>

    <section id="favorites-panel" class="favorites-panel">
      <div class="favorites-header">
        <div class="favorites-header-title">Saved Favorites</div>
        <button id="btn-favorites-close" class="btn-mini">Close</button>
      </div>
      <div id="favorites-empty" class="favorites-empty">
        No favorites yet.
      </div>
      <div id="favorites-list"></div>
    </section>
  </div>

  <script>
    // ---------- BRANCHES ----------

    const branches = [
      { id: "characterType", label: "Character Type", icon: "üßô‚Äç‚ôÇÔ∏è" },
      { id: "characterBuild", label: "Character Build", icon: "üßç" },
      { id: "device", label: "Device", icon: "üìü" },
      { id: "weapon", label: "Weapon", icon: "‚öîÔ∏è" },
      { id: "artifact", label: "Artifact", icon: "üóø" },
      { id: "vehicle", label: "Vehicle", icon: "üöô" },
      { id: "building", label: "Building", icon: "üèõÔ∏è" },
      { id: "environment", label: "Environment", icon: "üåÜ" },
      { id: "plant", label: "Plant / Flora", icon: "üåø" },
      { id: "creature", label: "Creature / Species", icon: "üêæ" },
      { id: "scene", label: "Scene", icon: "üé¨" }
    ];

    const randChoice = (arr) => arr[Math.floor(Math.random() * arr.length)];

    function createDetailRows(container, details) {
      container.innerHTML = "";
      details.forEach((item) => {
        const label = document.createElement("div");
        label.className = "field-label";
        label.textContent = item.label;

        const value = document.createElement("div");
        value.className = "field-value";
        value.textContent = item.value || "‚Äî";
        if (!item.value) value.classList.add("field-muted");

        container.appendChild(label);
        container.appendChild(value);
      });
    }

    // ---------- BRANCH GENERATORS (unchanged from your previous version) ----------

    function genCharacterType() {
      return {
        subtitle: "Character type for your next project.",
        details: [
          { label: "Archetype", value: randChoice([
            "Wanderer", "Mystic", "Soldier / Veteran",
            "Scholar", "Outcast", "Detective", "Caretaker"
          ]) },
          { label: "Genre Flavor", value: randChoice([
            "Grounded modern", "Post-apocalyptic", "Low fantasy",
            "Space opera", "Urban occult", "Soft sci-fi"
          ]) },
          { label: "Social Role", value: randChoice([
            "Underworld / criminal", "Corporate", "Nomadic",
            "Academic", "Religious order", "Blue-collar"
          ]) },
          { label: "Core Motivation", value: randChoice([
            "Curiosity", "Revenge", "Survival", "Love / Connection",
            "Power / Control", "Redemption"
          ]) },
          { label: "Typical Vibe", value: randChoice([
            "Calm and observant", "Intense and focused", "Chaotic but charming",
            "Detached and cold", "Playful and irreverent"
          ]) }
        ]
      };
    }

    function genCharacterBuild() {
      return {
        subtitle: "Randomized physical build & expression.",
        details: [
          { label: "Gender", value: randChoice(["Male","Female","Other"]) },
          { label: "Height", value: randChoice(["Tall","Average","Short"]) },
          { label: "Stature", value: randChoice(["Skinny","Athletic","Heavyset"]) },
          { label: "Torso", value: randChoice([
            "Balanced torso", "Long torso / short legs", "Short torso / long legs"
          ]) },
          { label: "Neck", value: randChoice([
            "Thin long neck","Thick short neck","Standard"
          ]) },
          { label: "Arms", value: randChoice([
            "Normal long arms","Short thick arms","Standard"
          ]) },
          { label: "Hands", value: randChoice([
            "Thin small hands","Thick large hands","Standard"
          ]) },
          { label: "Feet", value: randChoice([
            "Thin small feet","Thick large feet","Standard"
          ]) },
          { label: "Legs", value: randChoice([
            "Normal long legs","Short stocky legs","Standard"
          ]) },
          { label: "Head Shape", value: randChoice([
            "Circle","Vertical oval","Horizontal rectangle",
            "Triangle up","Triangle down","Diamond"
          ]) },
          { label: "Feature Layout", value: randChoice([
            "Features high on the head","Features mid on the head","Features low on the head"
          ]) },
          { label: "Posture", value: randChoice([
            "Relaxed","Aggressive","Alert","Tired","Neutral","Slouched"
          ]) },
          { label: "Activity", value: randChoice([
            "Standing casually","Moving gesturally","Behaving in a focused manner","Holding an object"
          ]) },
          { label: "Mouth", value: randChoice([
            "Thin","Full","Smirk","Frown","Open","Basic line","Neutral"
          ]) },
          { label: "Nose", value: randChoice([
            "Round","Straight","Squiggle","Wide","Short","Tall / long","No nose"
          ]) },
          { label: "Eyes", value: randChoice([
            "Dots","Standard","Highly emotive","Droopy","Blank","Closed"
          ]) },
          { label: "Hair", value: randChoice([
            "Short","Long","Average","Bald","Messy","Outlandish","Classy"
          ]) },
          { label: "Clothing", value: randChoice([
            "Tight","Flowing","Casual","Formal","Sparse","Layered","Activewear"
          ]) },
          { label: "Accessories", value: randChoice([
            "Minimal jewelry", "Sunglasses, bag, patches", "Scarf & earphones",
            "Pouches & tools", "Visible tattoos & piercings"
          ]) },
          { label: "Footwear", value: randChoice([
            "Barefoot / minimal","Casual sneakers","Industrial / utility boots",
            "Combat / military boots","Formal shoes","Experimental / unusual"
          ]) },
          { label: "Emotion", value: randChoice([
            "Calm / relaxed","Focused / determined","Angry / tense","Sad / melancholic",
            "Amused","Exhausted","Detached / blank"
          ]) },
          { label: "Gaze", value: randChoice([
            "Direct / forward","Downcast / avoidant","Sideward / glancing",
            "Wide / startled","Half-lidded / tired","Closed"
          ]) },
          { label: "Build Accent", value: randChoice([
            "Broad shoulders","Narrow shoulders","Sloped shoulders",
            "Large head relative to body","Small head relative to body",
            "Uneven stance / hip drop","Asymmetry in limbs","Missing / augmented limb"
          ]) }
        ]
      };
    }

    function genDevice() {
      return {
        subtitle: "Randomized device / gadget idea.",
        details: [
          { label: "Category", value: "Device" },
          { label: "Form Factor", value: randChoice([
            "Handheld","Wearable","Remote / drone unit","Mounted console"
          ]) },
          { label: "Interface", value: randChoice([
            "Buttons / switches","Touchscreen","Voice-activated",
            "Neural / bio-link","Hybrid controls"
          ]) },
          { label: "Power Source", value: randChoice([
            "Battery / stored energy","Solar","Kinetic / manual",
            "Fusion / high-density","Biological / symbiotic","Unknown"
          ]) },
          { label: "Material", value: randChoice([
            "Plastic / polymer","Metal","Ceramic / glass",
            "Carbon-fiber composite","Bio-grown material"
          ]) },
          { label: "Condition", value: randChoice([
            "New / clean","Patched / modified","Worn / scuffed",
            "Damaged / semi-functional","Ancient but working","Glitchy / unstable"
          ]) },
          { label: "Capabilities", value: randChoice([
            "Recording & playback","Diagnostics & analysis",
            "Remote control capability","Scanning / mapping",
            "Life-support assistance","Communication relay"
          ]) },
          { label: "Aesthetic", value: randChoice([
            "Sleek / modern","Brutalist / industrial","Ornate / retro-tech",
            "Improvised / kitbashed","Organic / bio-sculpted","Alien"
          ]) },
          { label: "Accents", value: randChoice([
            "Warning labels, stickers, iconography",
            "Exposed wiring & scratched surfaces",
            "Runes / carvings in the casing",
            "Custom paint & worn grip",
            "No visible ornament"
          ]) }
        ]
      };
    }

    function genWeapon() {
      return {
        subtitle: "Randomized weapon idea.",
        details: [
          { label: "Category", value: "Weapon" },
          { label: "Class", value: randChoice([
            "Melee","Ranged","Thrown","Improvised","Exotic","Dual-purpose tool/weapon"
          ]) },
          { label: "Subtype", value: randChoice([
            "Sword","Knife / Dagger","Axe","Hammer / Maul","Spear / Polearm",
            "Pistol","Rifle","Energy projector","Gravity weapon","Artifact blade"
          ]) },
          { label: "Size", value: randChoice([
            "Small","Medium","Large","Massive / two-handed"
          ]) },
          { label: "Material", value: randChoice([
            "Metal","Wood","Stone","Synthetic / polymer","Crystal",
            "Bone / organic","Composite / mixed"
          ]) },
          { label: "Condition", value: randChoice([
            "Pristine","Well-kept","Worn","Damaged","Broken but usable"
          ]) },
          { label: "Style", value: randChoice([
            "Sleek / modern","Brutal / heavy","Elegant / ornate",
            "Primitive / crude","Ritualistic / decorated","Makeshift / assembled"
          ]) },
          { label: "Functional Features", value: randChoice([
            "Sharpened & serrated edge","Energy emitter & trigger mechanism",
            "Modular parts with sheath","Reinforced spine & counterweight",
            "Elemental effect (fire/electric/chemical)"
          ]) },
          { label: "Accents", value: randChoice([
            "Engravings & blood grooves","Runes / glyphs along blade",
            "Stickers & personal markings","Taped repairs & charms",
            "None / unadorned"
          ]) },
          { label: "Context", value: randChoice([
            "Military-issued","Civilian-modified","Ritual / ceremonial",
            "Ancient heirloom","Found object","Prototype / experimental"
          ]) }
        ]
      };
    }

    function genArtifact() {
      return {
        subtitle: "Randomized artifact / relic idea.",
        details: [
          { label: "Category", value: randChoice([
            "Relic / object of veneration","Idol / statue",
            "Tool / implement","Text / tablet / scroll",
            "Container / vessel","Key / seal / sigil","Map / chart / diagram"
          ]) },
          { label: "Origin", value: randChoice([
            "Ancient civilization","Classical empire","Medieval culture",
            "Industrial age society","Contemporary culture",
            "Futuristic / high-tech","Alien / non-human","Unknown / disputed"
          ]) },
          { label: "Apparent Age", value: randChoice([
            "Ancient","Old","Recent","Timeless / hard to date"
          ]) },
          { label: "Material", value: randChoice([
            "Stone","Metal","Wood","Bone / organic","Clay / ceramic",
            "Glass / crystal","Fabric / leather","Composite","Unidentifiable"
          ]) },
          { label: "Scale", value: randChoice([
            "Tiny / palm-sized","Small / handheld","Medium / torso-sized",
            "Large / body-scale","Monumental / hard to move"
          ]) },
          { label: "Design Style", value: randChoice([
            "Minimal","Ornate","Geometric","Organic / flowing",
            "Chaotic / assembled","Ritualistic / symbolic","Mechanical / engineered",
            "Alien / unreadable"
          ]) },
          { label: "Condition", value: randChoice([
            "Intact","Worn smooth","Chipped","Cracked but stable",
            "Fragmentary","Restored / repaired","Corroded"
          ]) },
          { label: "Markings", value: randChoice([
            "None visible","Simple symbols / tallies","Legible text",
            "Unknown script","Pictograms / narrative scenes",
            "Layered additions from different eras","Graffiti / defacement",
            "Faint traces, mostly worn away"
          ]) },
          { label: "Perceived Aura", value: randChoice([
            "Sacred / protective","Cursed / ominous","Communicative / message-bearing",
            "Key to something","Memory-recording","Seems mundane but rumored to matter",
            "Completely unreadable","Tied to specific legend"
          ]) }
        ]
      };
    }

    function genVehicle() {
      return {
        subtitle: "Randomized vehicle idea.",
        details: [
          { label: "Category", value: "Vehicle" },
          { label: "Vehicle Type", value: randChoice([
            "Ground","Air","Water","Space","Hybrid / multi-terrain",
            "Biological / living","Improvised / homemade"
          ]) },
          { label: "Class / Scale", value: randChoice([
            "Personal (1 person)","Small crew (2‚Äì6)","Transport (6‚Äì20)",
            "Heavy vehicle (industrial/military)","Massive / capital scale"
          ]) },
          { label: "Propulsion", value: randChoice([
            "Wheels / tracks","Legs (walker)","Rotors / fans",
            "Jet / rocket","Magnetic / hover","Sails / currents",
            "Biological motion","Exotic / unknown"
          ]) },
          { label: "Construction Material", value: randChoice([
            "Metal","Composite","Ceramic / heat shield","Fabric / lightweight",
            "Wood","Bone / organic","Unknown alloy"
          ]) },
          { label: "Primary Role", value: randChoice([
            "Civilian transport","Freight / cargo","Military / armed",
            "Scientific / research","Emergency / rescue",
            "Stealth / reconnaissance","Sport / racing","Luxury / ceremonial",
            "Improvised survival vehicle"
          ]) },
          { label: "Condition", value: randChoice([
            "Pristine","Used / maintained","Weathered / old",
            "Damaged","Salvaged / rebuilt","Barely functional"
          ]) },
          { label: "Aesthetic", value: randChoice([
            "Sleek","Brutal / angular","Rounded / retro","Patchwork / scavenged",
            "Ornate","Alien","Organic / grown"
          ]) },
          { label: "Features", value: randChoice([
            "Weapon mount & reinforced armor","Cargo compartments & sensors array",
            "Cockpit canopy & stabilizers","Deployable limbs & auxiliary power",
            "Autopilot / AI core","No notable extra features"
          ]) }
        ]
      };
    }

    function genBuilding() {
      return {
        subtitle: "Randomized building / structure idea.",
        details: [
          { label: "Primary function", value: randChoice([
            "Residential (home/apartment)","Commercial (shops/offices)",
            "Industrial (factory/plant)","Religious (temple/shrine)",
            "Civic / institutional","Military / fortified","Informal dwelling",
            "Ruin / derelict structure"
          ]) },
          { label: "Structure", value: randChoice([
            "Geometric / Brutalist style, sprawling / horizontal emphasis",
            "Vertical tower with narrow footprint",
            "Courtyard-centered cluster",
            "Labyrinthine interior layout",
            "Modules connected by walkways",
            "Embedded in terrain / carved into rock"
          ]) },
          { label: "Primary Material", value: randChoice([
            "Stone masonry","Brick","Concrete","Wood / timber",
            "Steel and glass","Scrap / patchwork materials",
            "Organic / grown structures"
          ]) },
          { label: "Facade Details", value: randChoice([
            "Large window bays","Tiny slit windows","Balconies",
            "Mostly blank walls","Recessed entries","Arcades / colonnades",
            "No notable facade features"
          ]) },
          { label: "Roof Type", value: randChoice([
            "Flat roof / usable surface","Gabled roof","Domes",
            "Stepped / tiered roofs","Green roof / overgrown",
            "No roof / open or ruined"
          ]) },
          { label: "Surroundings", value: randChoice([
            "Dense urban streetfront","Narrow alley / inner courtyard",
            "Hilltop / elevated position","Waterfront / shoreline",
            "Forest edge / natural environment","Desert / exposed landscape",
            "Isolated lone structure"
          ]) },
          { label: "Ornamentation / signage", value: randChoice([
            "No ornamentation / very plain","Carvings / relief panels",
            "Painted murals","Graffiti layers","Religious symbols",
            "Corporate logos","Hanging lanterns / lights",
            "Utility cabling / exposed pipes"
          ]) },
          { label: "Interior mood", value: randChoice([
            "Warm / inviting and lived-in","Cold / institutional","Cluttered / hoarded",
            "Sparse / minimal","Industrial / noisy and mechanical",
            "Sacred / quiet and focused","Secretive / locked and restricted",
            "Repurposed from original function"
          ]) }
        ]
      };
    }

    function genEnvironment() {
      return {
        subtitle: "Randomized environment / setting idea.",
        details: [
          { label: "Biome", value: randChoice([
            "Dense urban core","Suburban fringe","Rural farmland",
            "Forest","Mountain","Desert","Coastal","Arctic","Otherworldly"
          ]) },
          { label: "Time of Day", value: randChoice([
            "Blazing midday","Golden hour","Twilight","Night","Pre-dawn"
          ]) },
          { label: "Weather", value: randChoice([
            "Clear","Overcast","Rainy","Stormy","Snowing","Foggy","Windy dust"
          ]) },
          { label: "Dominant Mood", value: randChoice([
            "Calm","Harsh","Oppressive","Melancholic","Hopeful","Surreal"
          ]) },
          { label: "Key Landmarks", value: randChoice([
            "Single dominant tower","Cluster of small structures",
            "Ruins half-buried","Bridge or overpass","Huge natural rock formation",
            "Endless repeating infrastructure"
          ]) },
          { label: "Foreground Element", value: randChoice([
            "Silhouetted figure","Fence or railing","Vehicle",
            "Plants / debris","Water / reflection","Scattered objects"
          ]) },
          { label: "Visual Noise Level", value: randChoice([
            "Minimal, clean forms","Moderately busy","Very cluttered"
          ]) }
        ]
      };
    }

    function genPlant() {
      return {
        subtitle: "Randomized plant / flora idea.",
        details: [
          { label: "Category", value: randChoice([
            "Tree","Shrub / bush","Vine / creeper","Herb / small plant",
            "Fungus","Grasslike / reed","Aquatic plant","Alien flora"
          ]) },
          { label: "Growth Habit", value: randChoice([
            "Upright","Spreading","Climbing","Hanging","Floating",
            "Burrowing / emerging","Pulsing / animated"
          ]) },
          { label: "Size", value: randChoice([
            "Tiny","Small","Medium","Large","Massive / towering"
          ]) },
          { label: "Stem / Trunk", value: randChoice([
            "Single trunk","Multi-stalk","Hollow","Fibrous",
            "Woody","Fleshy","Porous / spongy"
          ]) },
          { label: "Leaves / Surface", value: randChoice([
            "Broad leaves","Needles","Fronds","Tiny clustered leaves",
            "Wax-coated","Fuzzy / hairy","Transparent","Bioluminescent"
          ]) },
          { label: "Reproductive Structures", value: randChoice([
            "Flowers","Spores","Pods","Cones","Berries / fruit",
            "Chemical sacs","Symbiotic nodes","Pulsing bulbs"
          ]) },
          { label: "Habitat", value: randChoice([
            "Forest","Desert","Wetlands","Mountain","Urban environment",
            "Cavern / subterranean","Ocean / aquatic","Alien biome"
          ]) },
          { label: "Traits", value: randChoice([
            "Edible","Medicinal","Toxic","Hallucinogenic",
            "Carnivorous","Parasitic","Bioluminescent",
            "Nervelike / reactive","Symbiotic with creatures"
          ]) }
        ]
      };
    }

    function genCreature() {
      return {
        subtitle: "Randomized creature / species idea.",
        details: [
          { label: "Ecological Domain", value: randChoice([
            "Terrestrial","Aquatic","Amphibious","Aerial",
            "Burrowing","Arboreal","Extra-dimensional"
          ]) },
          { label: "Body Plan", value: randChoice([
            "Humanoid","Quadruped","Hexapod","Many-legged",
            "Serpentine","Amorphous","Radial symmetry",
            "Crustacean-like","Soft-bodied / jelly-like"
          ]) },
          { label: "Analogue", value: randChoice([
            "Mammalian","Reptilian","Avian","Amphibian",
            "Insectoid","Arachnid","Fungal","Plant-like",
            "Mineral / rock-like","Energy / ethereal"
          ]) },
          { label: "Size Class", value: randChoice([
            "Tiny (insect)","Small (cat)","Medium (human)",
            "Large (horse / bear)","Huge (elephant / whale)",
            "Colossal (building-scale)"
          ]) },
          { label: "Surface", value: randChoice([
            "Fur / hair","Scales","Smooth skin","Armored plates",
            "Hard carapace","Chitin segments","Slime-coated",
            "Feathers","Bark-like","Translucent","Bioluminescent patterns"
          ]) },
          { label: "Head / Face", value: randChoice([
            "Elongated snout","Beaked face","Mandibles","Circular lamprey mouth",
            "Toothless wide maw","Mask-like face","Faceless",
            "One large central eye","Cluster of small eyes","Stalked eyes",
            "Tiny recessed eyes","Enormous expressive eyes"
          ]) },
          { label: "Limbs", value: randChoice([
            "Two arms, two legs","Four legs only","Multiple paired limbs",
            "Tentacles instead of limbs","Wing-limbs that also act as arms",
            "Stubby limbs / reduced mobility","No limbs, entire body moves",
            "Fine manipulators / delicate graspers"
          ]) },
          { label: "Extra Structures", value: randChoice([
            "Tail (simple)","Tail (prehensile)","Back spines / ridges",
            "Frills or crests","Horns","Antlers","Sacs / bulges",
            "Gills / breathing slits","Bioluminescent nodes",
            "Membrane fins or sails","Protective shell sections",
            "No notable extra structures"
          ]) },
          { label: "Abilities", value: randChoice([
            "Venomous bite or sting","Regenerative healing",
            "Camouflage / color-shifting","Extreme bursts of speed",
            "Wall-climbing","Gliding or short flight","Sonic scream",
            "Electric discharge","Toxin secretion","Ink / smoke defense",
            "Heat / cold resistance","Psychic presence"
          ]) },
          { label: "Temperament", value: randChoice([
            "Docile","Curious","Territorial","Predatory",
            "Skittish","Pack-oriented","Solitary","Parasitic","Symbiotic"
          ]) },
          { label: "Intelligence", value: randChoice([
            "Instinct-driven","Animal cunning","Tool-using",
            "Socially complex","Fully sapient","Hive-mind"
          ]) },
          { label: "Ecological Role", value: randChoice([
            "Apex predator","Active predator","Ambush predator",
            "Herbivore / grazer","Omnivore / opportunist",
            "Scavenger","Decomposer","Symbiont","Parasite"
          ]) }
        ]
      };
    }

    function genScene() {
      return {
        subtitle: "Randomized scene concept.",
        details: [
          { label: "Subject Focus", value: randChoice([
            "Character portrait","Small group moment","Wide establishing shot",
            "Creature encounter","Interior workspace","Exterior street vignette"
          ]) },
          { label: "Camera Viewpoint", value: randChoice([
            "Eye-level","Low angle","High angle","Over-the-shoulder",
            "Close-up","Distant wide shot"
          ]) },
          { label: "Composition", value: randChoice([
            "Rule-of-thirds focus","Centered / iconic","L-shaped framing",
            "Diagonal tension","Symmetrical","Asymmetrical with heavy foreground"
          ]) },
          { label: "Energy Level", value: randChoice([
            "Still / contemplative","Quietly tense","Chaotic / many elements in motion",
            "Dynamic but readable","Crowded but ordered"
          ]) },
          { label: "Scene Mood", value: randChoice([
            "Hopeful / uplifting","Somber / heavy","Uncanny / surreal",
            "Playful","Threatening","Clinical / detached"
          ]) },
          { label: "Detail Goal", value: randChoice([
            "Loose sketch with clear forms","Clean lines, flat color",
            "Fully rendered with lighting & texture","High contrast, graphic shapes"
          ]) },
          { label: "Subject Hint", value: randChoice([
            "Character-first composition","Environment-first composition",
            "Prop / object study","Gesture and motion study"
          ]) }
        ]
      };
    }

    const branchGenerators = {
      characterType: genCharacterType,
      characterBuild: genCharacterBuild,
      device: genDevice,
      weapon: genWeapon,
      artifact: genArtifact,
      vehicle: genVehicle,
      building: genBuilding,
      environment: genEnvironment,
      plant: genPlant,
      creature: genCreature,
      scene: genScene
    };

    // ---------- COLOR PALETTE SYSTEM ----------

    // Palette role labels (for hover hints)
    const paletteRoles = [
      "Primary",
      "Secondary",
      "Accent",
      "Neutral",
      "Pop",
      "Shadow",
      "Highlight",
      "Variant"
    ];

    // Conceptual modes: 100% curated, no math/jitter
    const conceptualPaletteSets = {
      warm: [
        ["#C73E1D","#E86252","#FF9F68","#FFC46B","#9A2E2E","#732626","#E5553C","#FFB45E"],
        ["#B33C2F","#E8704F","#FFB37A","#FFD98E","#8E2D3A","#6A2333","#D46257","#FFCA73"],
        ["#D9483B","#F07F4E","#FFB26B","#FFD188","#B1393C","#7C2A33","#E6674C","#FFC96C"],
        ["#E4572E","#F5853F","#FFB55A","#FFD06F","#B23C39","#7F2D37","#E7714A","#FFCA7A"],
        ["#D64550","#FF924A","#FFCF56","#E28413","#A63D40","#822E3A","#F08A4B","#FFD670"],
        ["#E35D45","#FF9F68","#FFC46B","#FFE082","#B63A3A","#8C2F3F","#F27D57","#FFD08A"],
        ["#E76F51","#F4A261","#E9C46A","#F6AE2D","#C44536","#8C2F39","#F08A5D","#FFD67D"],
        ["#F25C54","#FF8C42","#FFA552","#FFC857","#C3423F","#7F2A2A","#EF6F6C","#FFB26B"],
        ["#E63946","#F3722C","#F8961E","#F9C74F","#B72B34","#7C2030","#F28482","#FFD166"],
        ["#F94144","#F3722C","#F8961E","#F9C74F","#C0392B","#8E2C2C","#FF7C43","#FFD166"]
      ],
      cool: [
        ["#1D3557","#457B9D","#A8DADC","#F1FAEE","#0B1F3B","#2B4C7E","#4F8BC9","#86BBD8"],
        ["#0B132B","#1C2541","#3A506B","#5BC0BE","#6FFFE9","#070C1F","#274060","#3E6B89"],
        ["#102542","#235789","#4B8BBE","#8DB8DA","#D5E4F2","#0A1B30","#2E5984","#4F86C6"],
        ["#0D3B66","#3E5C76","#748CAB","#F0EBE3","#1B2A41","#324A5F","#5F7E9C","#9BB1D4"],
        ["#03045E","#0077B6","#00B4D8","#90E0EF","#CAF0F8","#001845","#023E8A","#0096C7"],
        ["#001219","#005F73","#0A9396","#94D2BD","#E9D8A6","#0B2838","#1A5C73","#3A86A8"],
        ["#14213D","#1F3C88","#2D5F9A","#1B98E0","#E8F1F2","#091833","#12355B","#33658A"],
        ["#202040","#283C63","#4A6FA5","#87A8D0","#D9E4F5","#181B3A","#2E4272","#5E7FB0"],
        ["#1B1B3A","#2C3E50","#3F5C94","#6EA4BF","#C4E0E5","#10152A","#273469","#4B88A2"],
        ["#050816","#1B1F3B","#273469","#4361EE","#4895EF","#090D1F","#2A4A7A","#75AADB"]
      ],
      muted: [
        ["#D8C3A5","#EAE7DC","#C3C9E9","#ADA8BE","#8E9AAF","#B0A8B9","#CBC0D3","#F1E9E5"],
        ["#C9CBA3","#FFE1A8","#E26D5C","#723D46","#472D30","#D8E2DC","#B0C4B1","#F0EAD2"],
        ["#E5D4C0","#D0B8AC","#F3D5B5","#E7D7C1","#C2B8A3","#A5A58D","#B7B7A4","#E9EDC9"],
        ["#CFC2B8","#E2D4BA","#E8D7F1","#D3C0CD","#A9A0AF","#8E9AAF","#AEB8FE","#CCD6F6"],
        ["#F4E1D2","#D9B08C","#C17C74","#6C567B","#393D3F","#8D89A6","#C7CCDB","#F6F5F3"],
        ["#D9D0C7","#CBB3A7","#A68A7F","#8D9F87","#6C8480","#9AA5A1","#C1CFC0","#F6F4F0"],
        ["#F6E8E0","#EBD4CB","#D6C1B1","#B49D89","#8F8073","#A3A9A4","#C1C6C3","#ECE9E4"],
        ["#DFD3C3","#F5EDE0","#E8D6CB","#D0B8A8","#B29F94","#A68A7C","#C4C1B7","#F5F1EB"],
        ["#D1C6AD","#E4D8C4","#F0E3D0","#C2B8A3","#9E9586","#8E8A79","#B7B5A4","#E7E4D5"],
        ["#DAD7CD","#E5E5E5","#F0EFEB","#C2C5AA","#A3B18A","#8A817C","#B6AD90","#F5F2E8"]
      ],
      noir: [
        ["#000000","#121212","#262626","#F8F9FA","#E63946","#1D1D1D","#343A40","#CED4DA"],
        ["#050608","#151515","#3B3B3B","#F5F5F5","#FF3366","#0B0C10","#1F2833","#C5C6C7"],
        ["#070707","#181818","#2B2B2B","#FDFDFD","#FF5C7A","#3A3A3A","#6A6A6A","#E9ECEF"],
        ["#050816","#141824","#262A38","#F8F9FF","#FF5C39","#212529","#495057","#DEE2E6"],
        ["#0B132B","#1C2541","#3A506B","#F8F9FA","#FF4D6D","#343A40","#ADB5BD","#FFFFFF"],
        ["#050811","#10141F","#202531","#F1F3F5","#FF4D6D","#343A40","#ADB5BD","#FFFFFF"],
        ["#020203","#111111","#222222","#FFFFFF","#D90429","#2B2D42","#8D99AE","#EDF2F4"],
        ["#040404","#161616","#2A2A2A","#FAFAFA","#F72585","#343434","#7E7E7E","#EDEDED"],
        ["#050505","#131313","#252525","#F7F7F7","#FF006E","#1E1E1E","#4B4B4B","#DDDDDD"],
        ["#010101","#151515","#2A2A2A","#FAFAFA","#FF595E","#323232","#6E6E6E","#E6E6E6"]
      ],
      earth: [
        ["#3B4D3B","#8AA05F","#C2C084","#E3D9A4","#6F5B3E","#415D43","#798478","#D8D5C7"],
        ["#6B5849","#B18F6A","#E0C9A6","#7A8F74","#415D43","#3D405B","#81B29A","#F2CC8F"],
        ["#4B3F36","#8C6D4C","#C0A080","#96A87D","#5A6B4A","#A98467","#B6AD90","#D9CAB3"],
        ["#5E503F","#9C6644","#C18C5D","#C2C5AA","#656D4A","#936639","#B08968","#EDE0D4"],
        ["#3F4238","#696D3A","#A1A77D","#D1D3B4","#8D5524","#C68642","#E0AC69","#F1E3D3"],
        ["#463F3A","#8A817C","#BCB8B1","#F4F3EE","#A5A58D","#6B705C","#CB997E","#DDBEA9"],
        ["#2F3E46","#52796F","#84A98C","#CAD2C5","#354F52","#5E7C60","#A3B18A","#E0E1DD"],
        ["#433425","#705335","#A47551","#C5A880","#6B705C","#A5A58D","#B7B7A4","#E9EDC9"],
        ["#3C2F2F","#7F4F24","#A65F46","#C37B59","#E9C46A","#F4A261","#6D6875","#463F3A"],
        ["#3B3024","#6F4F33","#9C6644","#C18C5D","#DDB892","#EDE0D4","#8C5C3F","#704C35"]
      ],
      pastel: [
        ["#FFC8DD","#FFAFCC","#BDE0FE","#A2D2FF","#F8F9FA","#FFE5EC","#E2ECE9","#DEE2FF"],
        ["#FFE5D9","#FFCDB2","#FFB4A2","#E5989B","#B5838D","#6D6875","#F2E9E4","#FAF9F6"],
        ["#FBF8CC","#FDE4CF","#FFCFD2","#F1C0E8","#CFBAF0","#A3C4F3","#90DBF4","#8EECF5"],
        ["#E2ECE9","#FDE2E4","#FAD2E1","#E9FFFB","#D7F9F8","#CDE7F0","#D9E2F2","#F1F3F8"],
        ["#FFF1E6","#FDE2E4","#FAD2E1","#E2ECE9","#BEE1E6","#CDDFFD","#E2F0CB","#F9F7F3"],
        ["#FDF0D5","#FDE2E4","#FAD2E1","#E2ECE9","#CDE7F0","#C8D6E5","#E2ECE9","#F8F9FA"],
        ["#F6D6D6","#FFD6BA","#FFE5B4","#F9F7CF","#D8F3DC","#B7E4C7","#95D5B2","#F5F3F4"],
        ["#FFE0F7","#F9E2FF","#E5D9F2","#D5E1DF","#F0EFEB","#FFE5EC","#E4C1F9","#D0BDF4"],
        ["#E5F4E3","#F3E5F5","#FFE3E3","#FFF0F0","#E3F2FD","#E8EAF6","#E0F2F1","#FFFDE7"],
        ["#F3E5F5","#E8EAF6","#E3F2FD","#E0F7FA","#E8F5E9","#FFFDE7","#FFF3E0","#FBE9E7"]
      ],
      neon: [
        ["#FF006E","#FB5607","#FFBE0B","#3A86FF","#8338EC","#FF0A54","#FF5400","#FFBD00"],
        ["#FF6B6B","#F9C74F","#90BE6D","#00F5D4","#5A189A","#9D4EDD","#00BBF9","#FF595E"],
        ["#FF1654","#FF9F1C","#2EC4B6","#00F5D4","#3A86FF","#FF006E","#FFBA08","#80FFDB"],
        ["#FF4D6D","#FF758F","#FFB5A7","#3F37C9","#4895EF","#4CC9F0","#F72585","#B5179E"],
        ["#F72585","#B5179E","#7209B7","#4361EE","#4895EF","#4CC9F0","#FFBA08","#FAA307"],
        ["#FF0054","#9B5DE5","#00BBF9","#00F5D4","#FEE440","#FFBD00","#FF006E","#FB5607"],
        ["#FF10F0","#FF2079","#FFBD00","#FFF740","#32FF6A","#18DCFF","#7EFFF5","#7158E2"],
        ["#FF47DA","#FF6AC1","#FF9A76","#F9ED69","#8AC926","#3A86FF","#8338EC","#FF006E"],
        ["#FF61A6","#FF85A1","#FFC971","#FFEA00","#00F5D4","#00BBF9","#3A86FF","#7209B7"],
        ["#FF3366","#FF6B6B","#FFD93D","#9B5DE5","#00BBF9","#00F5D4","#FF99C8","#FCF6BD"]
      ],
      rust: [
        ["#5A3A31","#8C5B3F","#B77946","#D9A66A","#3E2A22","#704C36","#9D6C47","#CFA474"],
        ["#4A3328","#7A533B","#A06E4F","#CCA37B","#36261F","#6C4B35","#926A4B","#BFA27A"],
        ["#422419","#6F3C2C","#99582A","#B08968","#DDB892","#EDE0D4","#7F4F24","#936639"],
        ["#3D2A20","#7A4F35","#B56535","#D4A276","#EDE0D4","#6F1D1B","#BB9457","#432818"],
        ["#4E342E","#6F4E37","#936639","#C08552","#E0B588","#F2DCC5","#7F5539","#5B3A29"],
        ["#3C2F2F","#7F4F24","#A65F46","#C37B59","#E9C46A","#F4A261","#6D6875","#463F3A"],
        ["#3B3024","#6F4F33","#9C6644","#C18C5D","#DDB892","#EDE0D4","#8C5C3F","#704C35"],
        ["#3F2F2F","#704438","#A15C3B","#C4784A","#DFAD71","#EDD8B5","#7F5B3A","#5C4033"],
        ["#452F28","#744234","#A45E3C","#C97A4D","#E1A96B","#F2D2A9","#815640","#5D3C30"],
        ["#3E2B26","#6D4338","#9A5D42","#C17B54","#DFA56D","#F0D2A8","#7B523C","#57382F"]
      ],
      cosmic: [
        ["#0B1E3D","#1B3B6F","#274060","#3A506B","#5BC0BE","#9FB4FF","#F4F4FF","#FAD4FF"],
        ["#050816","#1A1B41","#3A0CA3","#7209B7","#F72585","#FF9E00","#FFBA08","#F4F1DE"],
        ["#03045E","#023E8A","#0077B6","#00B4D8","#48CAE4","#ADE8F4","#CAF0F8","#F1FAEE"],
        ["#0B0B45","#25256B","#5A189A","#9D4EDD","#F72585","#7209B7","#4CC9F0","#FFC8DD"],
        ["#02010A","#10002B","#240046","#3C096C","#7B2CBF","#FF6F91","#FF9671","#FFC75F"],
        ["#050816","#12192F","#2B2D42","#3F37C9","#4895EF","#4CC9F0","#B5179E","#FFB3C6"],
        ["#050714","#151B3D","#1B3A4B","#27496D","#00909E","#00B4D8","#9D4EDD","#FFC8FF"],
        ["#04030F","#1A1635","#34227C","#513B9C","#7B5EA4","#C77DFF","#FFBDFF","#FFEEFF"],
        ["#090921","#1B1B3A","#2C3E50","#4C5B7A","#6C6E90","#A58FCC","#F2B5D4","#FDE2FF"],
        ["#05010D","#161327","#292F45","#3C4F76","#4F7CAC","#8FB8ED","#B5EAEA","#FFE5F1"]
      ]
    };

    const conceptualModes = Object.keys(conceptualPaletteSets);

    const theoryModes = [
      "mono",
      "analogous",
      "complementary",
      "splitComp",
      "triadic"
    ];

    const allPaletteModes = [...conceptualModes, ...theoryModes];

    const paletteLabels = {
      warm: "Warm / energetic",
      cool: "Cool / calm",
      muted: "Muted / dusty",
      noir: "Noir / high contrast",
      earth: "Earthy / natural",
      pastel: "Pastel / soft",
      neon: "Neon / cyber",
      rust: "Rust / industrial",
      cosmic: "Cosmic / iridescent",
      mono: "Monochromatic color scheme",
      analogous: "Analogous color scheme",
      complementary: "Complementary color scheme",
      splitComp: "Split-complementary color scheme",
      triadic: "Triadic color scheme"
    };

    // HSL -> HEX for theory modes
    function hslToHex(h, s, l) {
      h = ((h % 360) + 360) % 360;
      s = Math.min(1, Math.max(0, s));
      l = Math.min(1, Math.max(0, l));

      const c = (1 - Math.abs(2 * l - 1)) * s;
      const x = c * (1 - Math.abs(((h / 60) % 2) - 1));
      const m = l - c / 2;

      let r2 = 0, g2 = 0, b2 = 0;

      if (h < 60) { r2 = c; g2 = x; }
      else if (h < 120) { r2 = x; g2 = c; }
      else if (h < 180) { g2 = c; b2 = x; }
      else if (h < 240) { g2 = x; b2 = c; }
      else if (h < 300) { r2 = x; b2 = c; }
      else { r2 = c; b2 = x; }

      const R = Math.round((r2 + m) * 255);
      const G = Math.round((g2 + m) * 255);
      const B = Math.round((b2 + m) * 255);

      return "#" + [R,G,B].map(v => v.toString(16).padStart(2,"0")).join("").toUpperCase();
    }

    function generateTheoryPalette(mode) {
      const baseH = Math.random() * 360;
      const baseS = 0.65;
      const baseL = 0.45;
      const colors = [];

      if (mode === "mono") {
        const lights = [0.18,0.28,0.38,0.48,0.58,0.68,0.78,0.88];
        lights.forEach(lv => colors.push(hslToHex(baseH, baseS, lv)));
      }

      if (mode === "analogous") {
        const hues = [baseH - 40, baseH - 20, baseH, baseH + 20, baseH + 40];
        const lightness = [0.25,0.35,0.45,0.55,0.65,0.4,0.3,0.6];
        for (let i = 0; i < 8; i++) {
          const h = hues[i % hues.length];
          const l = lightness[i];
          colors.push(hslToHex(h, baseS, l));
        }
      }

      if (mode === "complementary") {
        const compH = baseH + 180;
        const roles = [
          [baseH, 0.80, 0.30],
          [compH, 0.85, 0.55],
          [baseH, 0.60, 0.65],
          [compH, 0.75, 0.22],
          [baseH, 0.90, 0.48],
          [compH, 0.55, 0.72],
          [baseH, 0.70, 0.88],
          [compH, 0.80, 0.40]
        ];
        roles.forEach(([h,s,l]) => colors.push(hslToHex(h,s,l)));
      }

      if (mode === "splitComp") {
        const leftH = baseH + 150;
        const rightH = baseH + 210;
        const roles = [
          [baseH,   0.70, 0.30],
          [leftH,   0.80, 0.45],
          [rightH,  0.80, 0.55],
          [baseH,   0.60, 0.65],
          [leftH,   0.75, 0.25],
          [rightH,  0.75, 0.35],
          [baseH,   0.85, 0.78],
          [leftH,   0.65, 0.55]
        ];
        roles.forEach(([h,s,l]) => colors.push(hslToHex(h,s,l)));
      }

      if (mode === "triadic") {
        const h2 = baseH + 120;
        const h3 = baseH + 240;
        const roles = [
          [baseH, 0.75, 0.30],
          [h2,    0.75, 0.40],
          [h3,    0.75, 0.50],
          [baseH, 0.60, 0.60],
          [h2,    0.65, 0.70],
          [h3,    0.65, 0.80],
          [baseH, 0.85, 0.50],
          [h2,    0.85, 0.35]
        ];
        roles.forEach(([h,s,l]) => colors.push(hslToHex(h,s,l)));
      }

      if (!colors.length) {
        // fallback = monochrome
        const lights = [0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9];
        lights.forEach(lv => colors.push(hslToHex(baseH, baseS, lv)));
      }

      return {
        colors,
        label: paletteLabels[mode] || "Color theory scheme"
      };
    }

    function generateConceptualPalette(mode) {
      const pool = conceptualPaletteSets[mode];
      if (!pool || !pool.length) {
        // Fallback to a theory mono palette if something is wrong
        return generateTheoryPalette("mono");
      }
      const colors = randChoice(pool).slice(0, 8);
      return {
        colors,
        label: paletteLabels[mode] || "Conceptual palette"
      };
    }

    function randomPaletteMode() {
      return randChoice(allPaletteModes);
    }

    function generatePalette(mode) {
      if (conceptualModes.includes(mode)) {
        return generateConceptualPalette(mode);
      }
      if (theoryModes.includes(mode)) {
        return generateTheoryPalette(mode);
      }
      const fallbackMode = randomPaletteMode();
      if (conceptualModes.includes(fallbackMode)) {
        return generateConceptualPalette(fallbackMode);
      }
      return generateTheoryPalette("mono");
    }

    // ---------- FAVORITES STORAGE ----------

    const FAVORITES_KEY = "wtd_favorites_v1";
    let favorites = [];

    function loadFavorites() {
      try {
        const raw = localStorage.getItem(FAVORITES_KEY);
        if (raw) favorites = JSON.parse(raw);
      } catch (e) {
        favorites = [];
      }
      updateFavoritesUI();
    }

    function saveFavorites() {
      localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
      updateFavoritesUI();
    }

    function addFavorite(entry) {
      favorites.unshift(entry);
      saveFavorites();
    }

    function deleteFavorite(idx) {
      favorites.splice(idx, 1);
      saveFavorites();
    }

    function updateFavoritesUI() {
      const countEl = document.getElementById("favorites-count");
      countEl.textContent = favorites.length.toString();

      const listEl = document.getElementById("favorites-list");
      const emptyEl = document.getElementById("favorites-empty");
      listEl.innerHTML = "";

      if (!favorites.length) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      favorites.forEach((fav, idx) => {
        const item = document.createElement("div");
        item.className = "favorite-item";

        const meta = document.createElement("div");
        meta.className = "favorite-meta";
        const left = document.createElement("div");
        left.innerHTML = `<span class="favorite-branch">${fav.branchLabel}</span>`;
        const right = document.createElement("div");
        right.textContent = fav.timestamp;
        meta.appendChild(left);
        meta.appendChild(right);

        const body = document.createElement("div");
        body.className = "favorite-body";
        body.textContent = fav.summary;

        const swatchesRow = document.createElement("div");
        swatchesRow.className = "favorite-swatches";
        fav.palette.forEach(col => {
          const sw = document.createElement("div");
          sw.className = "favorite-swatch";
          sw.style.background = col;
          swatchesRow.appendChild(sw);
        });

        const actions = document.createElement("div");
        actions.className = "favorite-actions";
        const copyBtn = document.createElement("button");
        copyBtn.className = "btn-mini";
        copyBtn.textContent = "Copy";
        copyBtn.onclick = () => copyToClipboard(fav.fullText);

        const delBtn = document.createElement("button");
        delBtn.className = "btn-mini danger";
        delBtn.textContent = "Delete";
        delBtn.onclick = () => deleteFavorite(idx);

        actions.appendChild(copyBtn);
        actions.appendChild(delBtn);

        item.appendChild(meta);
        item.appendChild(body);
        item.appendChild(swatchesRow);
        item.appendChild(actions);
        listEl.appendChild(item);
      });
    }

    // ---------- IDEA + PALETTE RENDERING ----------

    let mode = "random"; // 'random' | 'pick'
    let currentBranchId = null;
    let currentIdea = null;

    let currentPalette = { colors: [], label: "" };
    let visibleColorCount = 5;

    const branchRowEl = document.getElementById("branch-row");

    function buildBranchPills() {
      branchRowEl.innerHTML = "";
      branches.forEach((b) => {
        const pill = document.createElement("button");
        pill.className = "branch-pill";
        pill.dataset.id = b.id;
        pill.innerHTML = `<span class="icon">${b.icon}</span><span>${b.label}</span>`;
        pill.addEventListener("click", () => {
          setActiveBranch(b.id);
          generateIdea();
        });
        branchRowEl.appendChild(pill);
      });
    }

    function setActiveBranch(id) {
      currentBranchId = id;
      [...branchRowEl.querySelectorAll(".branch-pill")].forEach((pill) => {
        pill.classList.toggle("active", pill.dataset.id === id);
      });
    }

    function updateBranchRowEnabled() {
      if (mode === "pick") {
        branchRowEl.classList.remove("disabled");
      } else {
        branchRowEl.classList.add("disabled");
      }
    }

    function copyToClipboard(text) {
      navigator.clipboard?.writeText(text).catch(() => {});
    }

    function generateIdea() {
      let branch;
      if (mode === "random") {
        branch = randChoice(branches);
        setActiveBranch(branch.id);
      } else {
        branch =
          branches.find((b) => b.id === currentBranchId) ??
          randChoice(branches);
        setActiveBranch(branch.id);
      }

      const generator = branchGenerators[branch.id];
      if (!generator) return;

      const idea = generator();
      currentIdea = {
        branchId: branch.id,
        branchLabel: branch.label,
        icon: branch.icon,
        subtitle: idea.subtitle,
        details: idea.details
      };

      renderIdea(currentIdea);
    }

    function renderIdea(idea) {
      const iconEl = document.getElementById("branch-icon");
      iconEl.innerHTML = `<span>${idea.icon}</span>`;

      document.getElementById("branch-eyebrow").textContent = "Branch";
      document.getElementById("branch-title").textContent = idea.branchLabel;
      document.getElementById("branch-subtitle").textContent =
        idea.subtitle || "";

      const gridEl = document.getElementById("detail-grid");
      createDetailRows(gridEl, idea.details || []);

      document.getElementById("btn-favorite-current").textContent =
        "Add to Favorites ‚≠ê";
    }

    function applyPaletteToUI() {
      const labelEl = document.getElementById("palette-label");
      const swatchRow = document.getElementById("swatch-row");
      const hexRow = document.getElementById("hex-row");
      const countLabel = document.getElementById("color-count-label");
      const btnMinus = document.getElementById("btn-colors-minus");
      const btnPlus = document.getElementById("btn-colors-plus");

      const maxVisible = Math.min(8, currentPalette.colors.length);
      visibleColorCount = Math.min(visibleColorCount, maxVisible);
      visibleColorCount = Math.max(5, visibleColorCount);

      labelEl.textContent = currentPalette.label || "Palette";
      countLabel.textContent = visibleColorCount.toString();

      swatchRow.innerHTML = "";
      const visibleColors = currentPalette.colors.slice(0, visibleColorCount);
      hexRow.textContent = visibleColors.join(", ");

      visibleColors.forEach((col, index) => {
        const sw = document.createElement("div");
        sw.className = "swatch";
        sw.style.background = col;

        const role = paletteRoles[index % paletteRoles.length];
        sw.dataset.role = role;
        sw.title = `${role}: ${col}`;
        sw.addEventListener("click", () => {
          copyToClipboard(col);
        });

        swatchRow.appendChild(sw);
      });

      btnMinus.disabled = visibleColorCount <= 5;
      btnPlus.disabled = visibleColorCount >= maxVisible;
    }

    function resetAndRegeneratePalette() {
      const modeSel = document.getElementById("palette-mode");
      const selectedMode = modeSel.value;
      const pal = generatePalette(selectedMode);
      currentPalette = pal;
      visibleColorCount = 5;
      applyPaletteToUI();
    }

    function currentIdeaText() {
      if (!currentIdea) return "";
      const lines = [];
      lines.push(`Branch: ${currentIdea.branchLabel}`);
      lines.push(currentIdea.subtitle);
      lines.push("");
      (currentIdea.details || []).forEach((d) => {
        lines.push(`${d.label}: ${d.value}`);
      });
      lines.push("");
      const visibleColors = currentPalette.colors.slice(0, visibleColorCount);
      lines.push(`Colors (${visibleColorCount}): ${visibleColors.join(", ")}`);
      return lines.join("\n");
    }

    function summarizeIdeaForFavorite(idea) {
      if (!idea) return "";
      const primary = idea.details?.slice(0, 3) || [];
      return primary.map((d) => `${d.label}: ${d.value}`).join(" ¬∑ ");
    }

    // ---------- EVENTS ----------

    document.getElementById("btn-generate").addEventListener("click", () => {
      generateIdea();
      const modeSel = document.getElementById("palette-mode");
      const rndMode = randomPaletteMode();
      modeSel.value = rndMode;
      resetAndRegeneratePalette();
    });

    document.getElementById("btn-random-mode").addEventListener("click", () => {
      mode = "random";
      document.getElementById("btn-random-mode").classList.add("active");
      document.getElementById("btn-pick-mode").classList.remove("active");
      updateBranchRowEnabled();
    });

    document.getElementById("btn-pick-mode").addEventListener("click", () => {
      mode = "pick";
      document.getElementById("btn-pick-mode").classList.add("active");
      document.getElementById("btn-random-mode").classList.remove("active");
      updateBranchRowEnabled();
    });

    document.getElementById("palette-mode").addEventListener("change", () => {
      resetAndRegeneratePalette();
    });

    document
      .getElementById("btn-palette-random")
      .addEventListener("click", () => {
        const modeSel = document.getElementById("palette-mode");
        const rndMode = randomPaletteMode();
        modeSel.value = rndMode;
        resetAndRegeneratePalette();
      });

    document.getElementById("btn-colors-plus").addEventListener("click", () => {
      visibleColorCount = Math.min(8, visibleColorCount + 1);
      applyPaletteToUI();
    });

    document.getElementById("btn-colors-minus").addEventListener("click", () => {
      visibleColorCount = Math.max(5, visibleColorCount - 1);
      applyPaletteToUI();
    });

    document.getElementById("btn-copy-idea").addEventListener("click", () => {
      copyToClipboard(currentIdeaText());
    });

    document.getElementById("btn-copy-hex").addEventListener("click", () => {
      if (!currentPalette.colors.length) return;
      const visibleColors = currentPalette.colors.slice(0, visibleColorCount);
      copyToClipboard(visibleColors.join(", "));
    });

    document
      .getElementById("btn-favorite-current")
      .addEventListener("click", () => {
        if (!currentIdea) return;
        const visibleColors = currentPalette.colors.slice(0, visibleColorCount);
        const entry = {
          branchId: currentIdea.branchId,
          branchLabel: currentIdea.branchLabel,
          summary: summarizeIdeaForFavorite(currentIdea),
          fullText: currentIdeaText(),
          palette: visibleColors,
          timestamp: new Date().toLocaleString()
        };
        addFavorite(entry);
        document.getElementById("btn-favorite-current").textContent =
          "Saved ‚≠ê";
      });

    const favoritesPanel = document.getElementById("favorites-panel");

    document
      .getElementById("btn-favorites-toggle")
      .addEventListener("click", () => {
        favoritesPanel.classList.toggle("visible");
        document
          .getElementById("btn-favorites-toggle")
          .classList.toggle("active");
      });

    document
      .getElementById("btn-favorites-close")
      .addEventListener("click", () => {
        favoritesPanel.classList.remove("visible");
        document
          .getElementById("btn-favorites-toggle")
          .classList.remove("active");
      });

    // ---------- INIT ----------

    buildBranchPills();
    updateBranchRowEnabled();
    loadFavorites();

    generateIdea();
    const modeSelInit = document.getElementById("palette-mode");
    const initialMode = randomPaletteMode();
    modeSelInit.value = initialMode;
    resetAndRegeneratePalette();
  </script>
</body>
</html>
